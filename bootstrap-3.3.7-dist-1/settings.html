<!DOCTYPE html>
<html lang="en">

<head>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Settings | Life Style Store</title>
    <link href="css/bootstrap.css" rel="stylesheet">
    <link href="css/style.css" rel="stylesheet">
    <script src="js/jquery.js"></script>
    <script src="js/bootstrap.min.js"></script>
</head>

<body>
    <div class="container-fluid" id="content">
        <div class="navbar navbar-inverse navbar-fixed-top">
            <div class="container">
                <div class="navbar-header">
                    <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#myNavbar">
                        <span class="icon-bar"></span>
                        <span class="icon-bar"></span>
                        <span class="icon-bar"></span>
                    </button>
                    <a class="navbar-brand" href="products.html">Lifestyle Store</a>
                </div>
                <div class="collapse navbar-collapse" id="myNavbar">
                    <ul class="nav navbar-nav navbar-right">
                        <li><a href="cart.html"><span class="glyphicon glyphicon-shopping-cart"></span> Cart</a></li>
                        <li><a href="settings.html"><span class="glyhicon glyphicon-user"></span> Settings</a></li>
                        <li><a href="javascript:void(0)" onclick="logout()"><span
                                    class="glyphicon glyphicon-log-in"></span> Logout</a></li>
                    </ul>
                </div>
            </div>
        </div>
        <div class="container-fluid" id="content">
            <div class="row">
                <div class="col-lg-4 col-lg-offset-4" id="settings-container">
                    <h4>Change Password</h4>
                    <form onsubmit="return validate()" name="settingsForm" method="post">
                        <div class="form-group">
                            <input type="password" class="form-control" name="old_password" placeholder="Old Password"
                                required>
                        </div>
                        <div class="form-group">
                            <input type="password" class="form-control" name="new_password" placeholder="New Password"
                                required>

                        </div>
                        <div class="form-group">
                            <input type="password" class="form-control" name="retype_password"
                                placeholder="Re-type New Password" required>

                        </div>
                        <button type="submit" class="btn btn-primary">Change</button>
                    </form>
                </div>
            </div>
        </div>
    </div>
    <footer>
        <div class="container">
            <center>
                <p>Copyright &copy; Lifestyle Store. All Rights Reserved | Contact Us: +91 90000 00000</p>
            </center>
        </div>
    </footer>
    <script>
        function logout() {
            sessionStorage.setItem("isLoggedIn", false);
            sessionStorage.setItem("loggedInUserEmail", '');
            window.location.replace("login.html");
        }
        function validate() {
            let old_password = document.settingsForm.old_password.value;
            let new_password = document.settingsForm.new_password.value;
            let retype_password = document.settingsForm.retype_password.value;
            let email = sessionStorage.getItem("loggedInUserEmail");

            if (new_password === retype_password) {
                fetch(`http://localhost:3000/users?email=${email}&password=${old_password}`, {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json',
                    }
                })
                    .then(response => response.json())
                    .then(data => {
                        console.log(data);
                        if (data.length > 0) {
                            let payload = {
                                id: data[0].id,
                                name: data[0].name,
                                email: data[0].email,
                                password: new_password,
                                contact: data[0].contact,
                                city: data[0].city,
                                address: data[0].address
                            }
                            const putMethod = {
                                method: 'PUT', // Method itself
                                headers: {
                                    'Content-type': 'application/json; charset=UTF-8' // Indicates the content 
                                },
                                body: JSON.stringify(payload) // We send data in JSON format
                            }

                            // make the HTTP put request using fetch api
                            fetch(`http://localhost:3000/users/${payload.id}`, putMethod)
                                .then(response => response.json())
                                .then(data => {
                                    debugger;
                                    alert("Credentials successfully updated.");

                                }) // Manipulate the data retrieved back, if we want to do something with it
                                .catch(err => console.log(err))
                            // setTimeout(function () {
                            //     window.location.replace("products.html");
                            //     alert
                            // }, 100);
                            // sessionStorage.setItem("isLoggedIn", false);
                            // alert("Log In Successful");
                        }
                        else {
                            alert("Please Enter a valid old password.");
                            // sessionStorage.setItem("isLoggedIn", false);
                        }
                    })
                    .catch((error) => {
                        console.error('Error:', error);
                    });
            }
            else {
                alert("New password doesn't match with retyped password.");
            }

            //     var payload={
            //     "id":new Date().getTime().toString(),
            //     "name":document.signupForm.name.value,
            //     "email":document.signupForm.email.value,
            //     "password":document.signupForm.password.value,
            //     "contact":document.signupForm.contact.value,
            //     "city":document.signupForm.city.value,
            //     "Address":document.signupForm.address.value
            // }


            return false;
        }
    </script>
</body>

</html>